{% extends "base.html" %}

{% block content_head %}
    <div class="container-fluid am-cf">
        <div class="row">
            <div class="am-u-sm-12 am-u-md-12 am-u-lg-9">
                <div class="page-header-heading"><span class="am-icon-user page-header-heading-icon"></span> 用户管理
                </div>
            </div>
        </div>
    </div>
{% endblock content_head %}

{% block content_body %}
    <div class="row-content am-cf">
        <div class="widget am-cf">
            <div class="widget-head am-cf">
                <div class="widget-title am-fl">系统用户</div>
                <div class="widget-function am-fr">
                    <div class="widget-function am-fr">
<<<<<<< HEAD
                    <button type="button" id="add-user-btn" class="am-btn am-btn-success am-btn-xs am-radius"><i class="am-icon-plus"></i>添加用户</button>
=======
                        <button type="button" id="add-user-btn" class="am-btn am-btn-success am-btn-xs am-radius"><i
                                class="am-icon-plus"></i>添加用户
                        </button>
>>>>>>> master
                    </div>
                </div>
            </div>
            <div class="widget-body am-fr">
<<<<<<< HEAD
             <div style="min-height: 400px;width: 98%;margin: auto" class="">
                    <table width="100%" id="user-table"
                     class="am-table am-table-compact am-table-striped tpl-table-black am-text-nowrap">
                     <thead>
                     <tr>
                         <th class="name">姓名</th>
                         <th class="email">邮箱</th>
                         <th class="operation">操作</th>
                      </tr>
                     </thead>
                     </table>
            </div>
            </div>
            </div>
        </div>
    </div>
{% endblock content_body %}

{% block custom_modal %}
   <!--添加用户Modal-->
    <div class="am-modal am-modal-prompt" tabindex="-1" id="add-user-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">
                <h1>添加用户</h1>
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd">
                <div class="am-modal-bd">
                <form id="add-user-form" class="am-form am-form-horizontal" data-am-validator
                      method="post" action="api/user">
                    <div class="am-form-group">
                        <label for="add-form-name" class="am-u-sm-3 am-form-label">用户名</label>
                        <div class="am-u-sm-9">
                            <input type="text" id="name" name="name" minlength="0" maxlength="20"
                                   placeholder="用户名" data-rule-required='true' >
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="add-form-url" class="am-u-sm-3 am-form-label">邮箱</label>
                        <div class="am-u-sm-9">
                            <input type="email" id="email" name="email" minlength="1" maxlength="2083"
                                   placeholder="email" required>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="add-form-ip" class="am-u-sm-3 am-form-label">密码</label>
                        <div class="am-u-sm-9">
                            <input type="password" id="password" name="password" minlength="5" maxlength="64" placeholder="密码" required>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="add-form-port" class="am-u-sm-3 am-form-label">确认密码</label>
                        <div class="am-u-sm-9">
                            <input type="password" id="confirm" name="confirm" minlength="5" maxlength="64"
                                   placeholder="确认密码" required>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <!--<div class="am-u-sm-10 am-u-sm-offset-2">-->
                        <div>
                            <button id="add-form-submit-button" type="" class="am-btn am-btn-success">添加</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
    <!--编辑用户的Modal-->
    <div class="am-modal am-modal-no-btn" tabindex="-1" id="edit-user-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">
                <h1>编辑用户</h1>
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd">
                <form id="edit-user-form" class="am-form am-form-horizontal" data-am-validator
                      method="" action="">
                    <input type="number" id="edit-form-id" style="display: none;">
                    <div class="am-form-group">
                        <label for="add-form-name" class="am-u-sm-3 am-form-label">用户名</label>
                        <div class="am-u-sm-9">
                            <input type="text" id="edit-form-name" name="name" minlength="0" maxlength="20"
                                   placeholder="用户名" data-rule-required='true' >
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="add-form-url" class="am-u-sm-3 am-form-label">邮箱</label>
                        <div class="am-u-sm-9">
                            <input type="email" id="edit-form-email" name="email" minlength="1" maxlength="2083"
                                   placeholder="email" required>
                        </div>
                    </div>
                     <div class="am-form-group">
                        <label for="add-form-ip" class="am-u-sm-3 am-form-label">新密码</label>
                        <div class="am-u-sm-9">
                            <input type="password" id="password" name="password" minlength="5" maxlength="64" placeholder="新密码" required>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="add-form-port" class="am-u-sm-3 am-form-label">确认密码</label>
                        <div class="am-u-sm-9">
                            <input type="password" id="confirm" name="confirm" minlength="5" maxlength="64"
                                   placeholder="确认密码" required>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <!--<div class="am-u-sm-10 am-u-sm-offset-2">-->
                        <div>
                            <button id="edit-form-submit-button" type="" class="am-btn am-btn-success">提交</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--添加用户错误的Modal-->
    <div class="am-modal am-modal-alert" tabindex="-1" id="add-error-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">错误</div>
            <div class="am-modal-bd">
                添加用户失败！
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>
    <!--编辑小云错误的Modal-->
    <div class="am-modal am-modal-alert" tabindex="-1" id="edit-error-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">错误</div>
            <div class="am-modal-bd">
                编辑用户失败！
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>

     <!--确认删除小云的Modal-->
    <div class="am-modal am-modal-confirm" tabindex="-1" id="confirm-delete-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">警告</div>
            <div class="am-modal-bd">
                <!--TODO 最好显示该小云的部分信息，譬如说名字、URL什么的。-->
                确定要删除这个用户吗？
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn" data-am-modal-cancel>取消</span>
                <span class="am-modal-btn" data-am-modal-confirm>确定</span>
            </div>
        </div>
    </div>
     <!--删除用户错误的Modal-->
=======
                <div style="min-height: 400px;width: 98%;margin: auto" class="">
                    <table width="100%" id="user-table"
                           class="am-table am-table-compact am-table-striped tpl-table-black am-text-nowrap">
                        <thead>
                        <tr>
                            <th class="name">姓名</th>
                            <th class="email">邮箱</th>
                            <th class="operation">操作</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>
{% endblock content_body %}

{% block custom_modal %}
    <!--添加用户Modal-->
    <div class="am-modal am-modal-prompt" tabindex="-1" id="add-user-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">
                <h1>添加用户</h1>
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd">
                <div class="am-modal-bd">
                    <form id="add-user-form" class="am-form am-form-horizontal" data-am-validator
                          method="post" action="api/user">
                        <div class="am-form-group">
                            <label for="add-form-name" class="am-u-sm-3 am-form-label">用户名</label>
                            <div class="am-u-sm-9">
                                <input type="text" id="name" name="name" minlength="0" maxlength="20"
                                       placeholder="用户名" data-rule-required='true'>
                            </div>
                        </div>

                        <div class="am-form-group">
                            <label for="add-form-url" class="am-u-sm-3 am-form-label">邮箱</label>
                            <div class="am-u-sm-9">
                                <input type="email" id="email" name="email" minlength="1" maxlength="2083"
                                       placeholder="email" required>
                            </div>
                        </div>

                        <div class="am-form-group">
                            <label for="add-form-ip" class="am-u-sm-3 am-form-label">密码</label>
                            <div class="am-u-sm-9">
                                <input type="password" id="password" name="password" minlength="5" maxlength="64"
                                       placeholder="密码" required>
                            </div>
                        </div>

                        <div class="am-form-group">
                            <label for="add-form-port" class="am-u-sm-3 am-form-label">确认密码</label>
                            <div class="am-u-sm-9">
                                <input type="password" id="confirm" name="confirm" minlength="5" maxlength="64"
                                       placeholder="确认密码" required>
                            </div>
                        </div>

                        <div class="am-form-group">
                            <!--<div class="am-u-sm-10 am-u-sm-offset-2">-->
                            <div>
                                <button id="add-form-submit-button" type="" class="am-btn am-btn-success">添加</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!--编辑用户的Modal-->
    <div class="am-modal am-modal-no-btn" tabindex="-1" id="edit-user-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">
                <h1>编辑用户</h1>
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd">
                <form id="edit-user-form" class="am-form am-form-horizontal" data-am-validator
                      method="" action="">
                    <input type="number" id="edit-form-id" style="display: none;">
                    <div class="am-form-group">
                        <label for="add-form-name" class="am-u-sm-3 am-form-label">用户名</label>
                        <div class="am-u-sm-9">
                            <input type="text" id="edit-form-name" name="name" minlength="0" maxlength="20"
                                   placeholder="用户名" data-rule-required='true'>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="add-form-url" class="am-u-sm-3 am-form-label">邮箱</label>
                        <div class="am-u-sm-9">
                            <input type="email" id="edit-form-email" name="email" minlength="1" maxlength="2083"
                                   placeholder="email" required>
                        </div>
                    </div>
                    <div class="am-form-group">
                        <label for="add-form-ip" class="am-u-sm-3 am-form-label">新密码</label>
                        <div class="am-u-sm-9">
                            <input type="password" id="password" name="password" minlength="5" maxlength="64"
                                   placeholder="新密码" required>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="add-form-port" class="am-u-sm-3 am-form-label">确认密码</label>
                        <div class="am-u-sm-9">
                            <input type="password" id="confirm" name="confirm" minlength="5" maxlength="64"
                                   placeholder="确认密码" required>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <!--<div class="am-u-sm-10 am-u-sm-offset-2">-->
                        <div>
                            <button id="edit-form-submit-button" type="" class="am-btn am-btn-success">提交</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!--添加用户错误的Modal-->
    <div class="am-modal am-modal-alert" tabindex="-1" id="add-error-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">错误</div>
            <div class="am-modal-bd">
                添加用户失败！
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>

    <!--编辑用户错误的Modal-->
    <div class="am-modal am-modal-alert" tabindex="-1" id="edit-error-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">错误</div>
            <div class="am-modal-bd">
                编辑用户失败！
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>

    <!--确认删除用户的Modal-->
    <div class="am-modal am-modal-confirm" tabindex="-1" id="confirm-delete-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">警告</div>
            <div class="am-modal-bd">
                确定要删除这个用户吗？
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn" data-am-modal-cancel>取消</span>
                <span class="am-modal-btn" data-am-modal-confirm>确定</span>
            </div>
        </div>
    </div>

    <!--删除用户错误的Modal-->
>>>>>>> master
    <div class="am-modal am-modal-alert" tabindex="-1" id="delete-error-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">错误</div>
            <div class="am-modal-bd">
                删除用户失败！
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>
{% endblock custom_modal %}

{% block custom_script %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/amazeui.switch.css') }}"/>
    <script src="{{ url_for('static', filename='js/amazeui.switch.min.js') }}"></script>

    <script>
        (function () {
            var table = $('#user-table').DataTable({
                responsive: true,
                "lengthChange": false,
                "ajax": "api/user",
                "oLanguage": {// 汉化
                    "sLengthMenu": "",
                    "sZeroRecords": "",
<<<<<<< HEAD
                    "sSearch": "", // TODO 不知道为什么搜索框前面有文字的话，样式会换行，特别不好看。后期优化。
=======
                    "sSearch": "",
>>>>>>> master
                },
                "columns": [
                    {"data": "name"},
                    {"data": "email"},
                    {"data": "operation"},
                ],
                "columnDefs": [{
                    "targets": "nosort",
                    "orderable": false,
                }, {
                    "targets": "operation",
                    "data": null,
                    "defaultContent": '<button class="am-btn am-btn-primary am-btn-xs am-radius edit-user-button" style="margin-right:10px"><i class="am-icon-edit"></i></button>' +
                    '<button class="am-btn am-btn-danger am-btn-xs am-radius delete-user-button"><i class="am-icon-trash"></i></button>',
                }],
                "drawCallback": function () {
<<<<<<< HEAD
                    // 渲染Switch，并注册切换事件：用Ajax来发送请求。
{#                    $('[name="my-checkbox"]').bootstrapSwitch();#}
{#                    $('[name="my-checkbox"]').on('switchChange.bootstrapSwitch', function (event, state) {#}
{#                        var thisSwitch = $(this);#}
{#                        // 先切换成禁用状态。#}
{#                        thisSwitch.bootstrapSwitch('toggleDisabled');#}
{##}
{#                        var tr = this.closest('tr');#}
{#                        var row = table.row(tr);#}
{#                        var rowData = row.data();#}
{#                        var id = rowData.id;#}
{#                        var url = 'api/littlecloud/' + id.toString() + '/toggle_access_permission';#}
{#                        $.ajax({#}
{#                            url: url,#}
{#                            type: 'GET',#}
{#                            dataType: 'json',#}
{#                            success: function (data, textStatus, jqXHR) {#}
{#                                // 切换回可用状态。#}
{#                                thisSwitch.bootstrapSwitch('toggleDisabled');#}
{#                                if (data["result"] === false) {#}
{#                                    // 第二个参数设置为 true 时跳过执行 switchChange，才能避免死循环。#}
{#                                    thisSwitch.bootstrapSwitch('toggleState', true);#}
{##}
{#                                    $("#toggle-error-modal").modal({closeViaDimmer: 0});#}
{#                                }#}
{#                            },#}
{#                        })#}
{#                    });#}

=======
>>>>>>> master
                    // 往「删除按钮」注册点击事件：渲染出删除Modal。
                    $(".delete-user-button").on('click', function () {
                        $('#confirm-delete-modal').modal({
                            relatedTarget: this,
                            onConfirm: function (options) {
                                var $link = $(this.relatedTarget);
                                var tr = $link.closest('tr');
                                var row = table.row(tr);
                                var rowData = row.data();
                                deleteUserById(rowData.id);
                            },
                        });
                    });

                    // 往「编辑按钮」注册点击事件：渲染出编辑Modal。
                    $(".edit-user-button").on('click', function () {
                        var tr = this.closest('tr');
                        var row = table.row(tr);
                        var rowData = row.data();

                        // 清空表单数据。
                        $("#edit-user-form").get(0).reset();

                        // 覆盖表单数据。
                        $("#edit-form-id").val(rowData.id);
                        $("#edit-form-name").val(rowData.name);
                        $("#edit-form-email").val(rowData.email);
                        $("#edit-form-password").val(rowData.password);

                        // 渲染编辑modal。
                        $('#edit-user-modal').modal();

                        // 激活表单验证样式（渲染出modal后激活才有效果）。
                        var isFormValid = $('#edit-user-form').validator('isFormValid');
                    });
                },
            });
<<<<<<< HEAD
=======

>>>>>>> master
            //添加[创建用户]按钮,弹出[添加用户]modal
            $('#add-user-btn').on('click', function () {
                $('#add-user-modal').modal();
            });
<<<<<<< HEAD
            // 「添加小云Modal」窗口完全关闭的事件：清空「添加小云」表单数据和重置验证。
=======

            // 「添加用户Modal」窗口完全关闭的事件：清空「添加用户」表单数据和重置验证。
>>>>>>> master
            $('#add-user-modal').on('closed.modal.amui', function () {
                // 清空表单数据。
                $("#add-user-form").get(0).reset();

                // 重置表单验证。
                $("#add-user-form").validator('destroy');
                $("#add-user-form").validator();
            });
<<<<<<< HEAD
=======

>>>>>>> master
            //提交[创建用户]表单
            $('#add-user-form').submit(function (e) {
                $(this).ajaxSubmit({
                    // 提交前的回调函数：用于判断表单验证是否通过。
                    beforeSubmit: function (formData, jqForm, options) {
                        var formValidity = $('#add-user-form').validator('isFormValid');
                        if (formValidity) {
                            $('#add-user-modal').modal('close');
                            return true;
                        }
                        return false;
                    },
                    // 提交后的回调函数
                    success: function (responseObject, statusText) {
                        if (responseObject['result']) {
                            table.ajax.reload();
                        } else {
                            $("#add-error-modal").modal({closeViaDimmer: 0});
                            console.log(responseObject['message']); // TODO 便于调试的错误信息，后期应删掉
                        }
                    },
                    url: "api/user",
                    type: "post",
                    dataType: "json"
                });

                return false;
            });
<<<<<<< HEAD
            // 「编辑小云表单」的提交方法：采用异步提交的方式。
=======

            // 「编辑用户表单」的提交方法：采用异步提交的方式。
>>>>>>> master
            $('#edit-user-form').submit(function (e) {
                var id = $("#edit-form-id").val();
                var url = "api/user/" + id.toString();

                $(this).ajaxSubmit({
                    // 提交前的回调函数：用于判断表单验证是否通过。
                    beforeSubmit: function (formData, jqForm, options) {
                        var formValidity = $('#edit-user-form').validator('isFormValid');
                        if (formValidity) {
                            $('#edit-user-modal').modal('close');
                            return true;
                        }
                        return false;
                    },
                    // 提交后的回调函数
                    success: function (responseObject, statusText) {
                        if (responseObject['result']) {
                            table.ajax.reload();
                        } else {
                            $("#edit-error-modal").modal({closeViaDimmer: 0});
                            console.log(responseObject['message']); // TODO 便于调试的错误信息，后期应删掉
                        }
                    },
                    url: url,
                    type: "put",
                    dataType: "json"
                });

                return false;
            });


<<<<<<< HEAD
             // 根据ID删除用户的函数：用Ajax来发送DELETE请求。
=======
            // 根据ID删除用户的函数：用Ajax来发送DELETE请求。
>>>>>>> master
            function deleteUserById(id) {
                var url = "api/user/" + id.toString();
                $.ajax({
                    url: url,
                    type: 'DELETE',
                    dataType: 'json',
                    success: function (data, textStatus, jqXHR) {
                        if (data["result"]) {
                            table.ajax.reload();
                        } else {
                            $("#delete-error-modal").modal({closeViaDimmer: 0});
                        }
                    },
                })
            }

        }());
    </script>
<<<<<<< HEAD
{% endblock custom_script %}
=======
{% endblock custom_script %}
>>>>>>> master
