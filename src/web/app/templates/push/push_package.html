{% extends "base.html" %}

{% block content_head %}
    <div class="container-fluid am-cf">
        <div class="row">
            <div class="am-u-sm-12 am-u-md-12 am-u-lg-9">
                <div class="page-header-heading"><span class="am-icon-mixcloud page-header-heading-icon"></span> 云推送
                    <small>上传应用安装包</small>
                </div>
                <p class="page-header-description">上传完毕后，还需要<a href="{{ url_for('push.application') }}">注册应用信息</a>，才能推送到小云。
                </p>
            </div>
        </div>
    </div>
{% endblock content_head %}

{% block content_body %}
    <div class="row-content am-cf">
        <div class="widget am-cf">
            <div class="widget-head am-cf">
                <div class="widget-title am-fl">安装包列表</div>
                <div class="widget-function am-fr">
                    <button type="button" id="add-package-btn" class="am-btn am-btn-success am-btn-xs am-radius">
                        <i class="am-icon-plus"></i>添加安装包
                    </button>
                </div>
            </div>
            <div class="widget-body am-fr">
                <div style="min-height: 400px;width: 98%;margin: auto" class="">
                    <table width="100%" id="package-table"
                           class="am-table am-table-compact am-table-striped tpl-table-black am-text-nowrap">
                        <thead>
                        <tr>
                            {#                            <th class="is_connectible nosort">接入权限</th>#}
                            {#                            <th class="name">小云名称</th>#}
                            {#                            <th class="url nosort">小云主页</th>#}
                            {#                            <th class="ip nosort">接入IP</th>#}
                            {#                            <th class="port nosort">接入端口</th>#}
                            {#                            <th class="protocol nosort">接入协议</th>#}
                            {#                            <th class="email nosort">联系邮箱</th>#}
                            {#                            <th class="phone nosort">联系电话</th>#}
                            {#                            <th class="operation nosort">操作</th>#}
                            <th class="">安装包</th>
                            <th class="">大小</th>
                            {#                            <th>关联信息</th>#}
                            {#                            <th>开始时间</th>#}
                            <th class="nosort">MD5</th>
                            <th class="">状态</th>
                            <th class="operation nosort">操作</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>

{% endblock content_body %}

{% block custom_modal %}
    <!--添加小云错误的Modal-->
    <div class="am-modal am-modal-alert" tabindex="-1" id="add-error-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">错误</div>
            <div class="am-modal-bd">
                添加小云失败！
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>

    <!--确认删除安装包的Modal-->
    <div class="am-modal am-modal-confirm" tabindex="-1" id="confirm-delete-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">警告</div>
            <div class="am-modal-bd">
                确定要删除这个安装包吗？
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn" data-am-modal-cancel>取消</span>
                <span class="am-modal-btn" data-am-modal-confirm>确定</span>
            </div>
        </div>
    </div>

    <!--删除安装包错误的Modal-->
    <div class="am-modal am-modal-alert" tabindex="-1" id="delete-error-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">错误</div>
            <div class="am-modal-bd">
                删除安装包失败！
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>

    <!--提醒用户浏览器不支持HTML5的Modal-->
    <div class="am-modal am-modal-alert" tabindex="-1" id="unsupported-html5-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">抱歉</div>
            <div class="am-modal-bd">
                您的浏览器不支持HTML5的一些特性导致上传功能缺失，请使用最新的Chrome或者Firefox！
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>

    <!--显示文件上传状态的Modal-->
    <div class="am-modal am-modal-no-btn" tabindex="-1" id="upload-file-modal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">
                <h1>正在上传文件</h1>
            </div>
            <div class="am-modal-bd">
                <div class="am-progress am-progress-striped am-active" style="height: 100%;">
                    <div id="upload-file-percent" class="am-progress-bar am-progress-bar-secondary" style="width: 57%"></div>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <button type="button" id="upload-file-pause" class="am-btn am-btn-warning am-radius">暂停</button>
                <button type="button" id="upload-file-continue" class="am-btn am-btn-success am-radius"
                        disabled="disabled">继续
                </button>
                <button type="button" id="upload-file-terminate" class="am-btn am-btn-danger am-radius">终止</button>
            </div>
        </div>
    </div>
{% endblock custom_modal %}


{% block custom_script %}
    <script src="{{ url_for('static', filename='js/resumable.js') }}"></script>

    <script>
        $(function () {
            // 初始化「小云白名单」表格。
            var table = $('#package-table').DataTable({
                responsive: true,
                "lengthChange": false,
                "order": [[0, 'asc']],
                "ajax": "api/package",
                "oLanguage": {
                    "sLengthMenu": "每页显示 _MENU_ 条记录",
                    "sZeroRecords": "没有检索到数据",
                    "sSearch": "",
                },
                "columns": [
                    {"data": "filename"},
                    {"data": "total_size"},
                    {"data": "md5"},
                    {"data": "is_complete"},
                    {"data": "operation"},
                ],
                "createdRow": function (row, data, index) {
                    var successTemplate = '<span class="am-badge am-badge-success am-round">上传成功</span>';
                    var uploadingTemplate = '<span class="am-badge am-badge-warning am-round">正在上传</span>';
                    if (data["is_complete"]) {
                        $('td', row).eq(3).html(successTemplate);
                    } else {
                        $('td', row).eq(3).html(uploadingTemplate);
                    }
                },
                "columnDefs": [{
                    "targets": "nosort",
                    "orderable": false,
                }, {
                    "targets": "operation",
                    "data": null,
                    "defaultContent": '<button class="am-btn am-btn-danger am-btn-xs am-radius delete-package-button"><i class="am-icon-trash"></i></button>',
                }],
                "drawCallback": function () {
                    // 往「删除按钮」注册点击事件：渲染出删除Modal。
                    $(".delete-package-button").on('click', function () {
                        $('#confirm-delete-modal').modal({
                            relatedTarget: this,
                            onConfirm: function (options) {
                                var $link = $(this.relatedTarget);
                                var tr = $link.closest('tr');
                                var row = table.row(tr);
                                var rowData = row.data();
                                deletePackageById(rowData.id);
                            },
                        });
                    });
                },
            });

            // 根据ID删除安装包的函数：用Ajax来发送DELETE请求。
            function deletePackageById(id) {
                var url = "api/package/" + id.toString();
                $.ajax({
                    url: url,
                    type: 'DELETE',
                    dataType: 'json',
                    success: function (data, textStatus, jqXHR) {
                        if (data["result"]) {
                            table.ajax.reload();
                        } else {
                            $("#delete-error-modal").modal({closeViaDimmer: 0});
                        }
                    },
                })
            }

{#            $("#upload-file-modal").modal({closeViaDimmer: 0});#}

            // 初始化Resumable
            var r = new Resumable({
                target: '/api/photo/redeem-upload-token',
                simultaneousUploads: 8,
            });
            if (r.support) {
                r.assignBrowse(document.getElementById('add-package-btn'));

                r.on('fileAdded', function (file) {
                    if ($('#' + file.uniqueIdentifier).length == 0) {
                    } else if ($('#' + file.uniqueIdentifier).find(".status").filter(".label-success")) {
                        if (!prompt("Do you actually want to override a exist file?")) {
                            file.cancel();
                            return;
                        }
                    }
                    uploadHandler(file);
                    $("#upload-file-modal").modal({closeViaDimmer: 0});
                    r.upload();
                });
                r.on('fileSuccess', function (file, message) {
                });
                r.on('fileError', function (file, message) {
                });
                r.on('fileProgress', function (file) {
                    bar = $("#upload-file-percent");
                    var percentage = file.progress() * 100;
                    var percentStr = percentage.toString() + "%";
                    bar.html(percentStr);
                    var percentStyle = "weight: " + percentStr + ";";
                    bar.attr("style", percentStyle);
                });
                r.on('complete', function () {
                });
            } else {
                $("#unsupported-html5-modal").modal({closeViaDimmer: 0});
            }

            function uploadHandler(file) {
                //pause upload
                function onPause() {
                    file.abort();
                }

                //continue upload
                function onContinue() {
                    file.retry();
                }

                //terminate upload
                function onTerminate() {
                    file.cancel();
                    $("#upload-file-modal").modal('close');
                }

                $("#upload-file-pause").bind("click", onPause);
                $("#upload-file-continue").bind("click", onContinue);
                $("#upload-file-terminate").bind("click", onTerminate);
            }
        });
    </script>
{% endblock custom_script %}